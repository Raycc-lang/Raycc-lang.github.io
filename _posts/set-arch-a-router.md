---

---

### 前言

在前一篇博文中，我写了自己在NanopiR2s上安装ArchLinuxArm的经历，现在是时候用它做一些事儿了。

R2S有两个网络接口非常适合做路由器，所以我的目标是用ArchLinux做家庭路由，当然最重要的是通过这个经历了解一些网络知识。

设置过程其实非常简单，但是本文的目的是希望读者对这个过程有深入的理解。想知道关于路由器的知识的话就读下去吧。

### 路由器

开始之前首先要了解一下什么是路由器。

相信每个人都至少见过路由器，家里的网络设备不管是有线还是无线都是要连接到路由器才能上网。

其实互联网就是很多个路由器连接起来的。家里或者公司里的网络请求会转发到电信运营商，运营商的路由器把你的网络请求转发给其他的网络。

可见路由器就是一个连接不同网络的设备。因此一个路由器通常至少有两个网络接口。

然后在路由器的内部使用一种叫做Masquerade的NAT技术，把数据包的源目标地址换成另一个网络接口的，加上Linux内核在不同接口之间转发数据包的功能，就可以实现两个网络的互连了。

接下来就来看看具体设置步骤。

### 安装步骤


##### 重命名接口
首先是一个可选的步骤，给两个网络接口重新命名。

比如把连接互联网的网卡命名为ext, 把连接局域网的设备命名为int.

有很多中方法可以做到这一点。在Linux系统中，设备由一个叫做udev的组件自动管理，其中当然也包括网络设备，既我们的网卡。Udev提供了一个可供其他组件调用的接口，也就是常说的网络接口，然后由专门管理网络的软件ne接手。 

我们可以更改udev的设置。

在/etc/udev/rules.d/文件夹中添加一个.link为后缀的文件，比如我们把它叫做10-network.rules。
然后添加以下内容：

```
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="", NAME="int"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="", NAME="ext"
```
因为有两个接口，所以有两条语句。使用ip link show显示所有的接口信息，然后在ATTR{address}后面加上接口对应的Mac地址。

或者改变netmanerger的设置文件。

ArchLinuxArm默认使用systemd-networkd。一样添加配置文件/etc/systemd/network/10-net0.link：

```
[Match]
PermanentMACAddress=aa:bb:cc:dd:ee:ff

[Link]
Name=net0
```
##### 接口设置

然后要对两个接口分别进行设置。

不同的网络管理软件的设置方式不同，不过大体思路都一样：
1. 在连接局域网的接口上设置静态IP和DHCP服务，这样连接局域网的设备可以使用该接口作为网关设备并自动获取IP地址。 
2. 在连接互联网的接口上拨号或者设置成自动获取地址，当然静态地址也可以。一般路由器会直接连接光猫，保证路由器和光猫可以通信即可。

